 #include <Stepper.h>
 #define STEPSperRevolution 200 // The step cnt for 1 cycle
 #define RPM 120
 #define Baudrate 9600
 #define WATER 0 // The pin of the water_sensor
 #define ON 1
 #define OFF 0
 #define REF_Water 300 // The reference value of the waterlevel
 #define STEPS 1024// The value of the step
 Stepper myStepper(STEPSperRevolution,11, 9, 10, 8);
  
byte val_water;
const byte ledPin = 3;
const byte interruptPin1 = 2; //interruptpin 디지털2번 설정
byte flag = OFF; // 모터 반복 수행 제어하기 위한 flag 변수
byte state = LOW; // 인터럽트 수행위한 state 변수

void setup() {
  myStepper.setSpeed(RPM); // 모터 설정
  pinMode(ledPin, OUTPUT); // 인터럽트 발생시 led 점등위한 led 핀 out설정
  pinMode(interruptPin1, INPUT_PULLUP);
  digitalWrite(interruptPin1, LOW);
  attachInterrupt(digitalPinToInterrupt(interruptPin1), step, CHANGE);
  Serial.begin(Baudrate);
  Serial.println("set up");
  Serial.println("state value of set up");
  Serial.println(state);
}

void loop() {
  Serial.println("loop");
  digitalWrite(ledPin, LOW);
  Serial.print("state :");
  Serial.println(state);
  check_waterlevel();
}


void check_waterlevel()
{
  val_water = analogRead(WATER);
  delay(1000);
  Serial.println(val_water);
  if(flag == OFF && val_water < REF_Water)
  {
    Serial.println("clockwise revolve");
    state = !state;
    digitalWrite(2, HIGH);
    Serial.println("changed state");
    Serial.println(state);
    flag = ON;
  }
  else if(flag == ON && val_water >= REF_Water)
  {
    state = !state;
    //digitalWrite(2, state);
    flag = OFF;
  }
}


void step() {
  Serial.println("step");
}
